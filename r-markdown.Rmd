# Using R Markdown
 
In a nutshell, R Markdown allows us to analyse our data with R and write a report in the same place (this entire book was written with rmarkdown). This has loads of benefits including a [*reproducible workflow*](https://www.youtube.com/watch?v=s3JldKoA0zw), and streamlined thinking. No more flipping back and forth between coding and writing to figure out what's going on.

Let's run some simple code as an example: 

```{r}
# Look at me go mom
x <- 2+2
x
```

What we've done here is write a snippet of R code, run it, and print the results (as they would appear in the console). While the above code isn't anything special, we can extend this concept so that our R markdown document contains any data, figures or plots we generate throughout our analysis in R. For example (don't worry about the specific functions here, they'll be covered in later chapters): 

```{r, message = FALSE, fig.cap= "Time series of 2018 ambient atmospheric O~3~, NO~2~, and SO~2~ concentrations (ppb) in downtown Toronto", fig.height=2}
library(tidyverse) 
library(knitr)

airPol <- read_csv("data/2018-01-01_60430_Toronto_ON.csv")

ggplot(data = airPol, 
       aes(x = date.time, 
           y = concentration, 
           colour = pollutant)) + 
  geom_line() +
  theme_classic()

sumAirPol <- airPol %>%
  drop_na() %>%
  group_by(city, naps, pollutant) %>%
  summarize(mean = mean(concentration), 
            sd = sd(concentration), 
            min = min(concentration), 
            max = max(concentration))

knitr::kable(sumAirPol, digits = 1)
```

Pretty neat, eh? You might not think so, but let's imagine a scenario you'll encounter soon enough. You're about to submit your assignment, you've spent hours analyzing your data and beautifying your plots. Everything is good to go until you notice at the last minute you were supposed to *subtract* value `x` and not value `y` in your analysis. If you did all your work in *Excel* (tsk tsk), you'll need to find the correct worksheet, apply the changes, reformat your plots, and import them into word (assuming everything is going well, which is never does with looming deadlines). Now if you did all your work in R markdown, you go to your one `.rmd` document, briefly apply the changes and re-compile your document.  

## Getting started with rmarkdown

As you've already guessed, R markdown documents use R and are most easily written and assembled in R Studio. If you have not done so, revisit Chapter 1:[Installing R]. Once setup with R and R Studio, you'll need to install the `rmarkdown` and `tinytex` packages. In the console, simply run the following code:

```{r, eval = FALSE}
# These are large packages so it'll take a couple of minutes to install

install.packages("rmarkdown") # downloaded from CRAN

install.packages("tinytex")
tinytex::install_tinytex()  # install TinyTeX

```
<!--Do rmarkdown and tinytex need to be loaded by library()? Or is just installing them enough?-->
The `rmarkdown` package is what we'll use to generate our documents, and the `tinytex` package lets us export them as PDFs. There's a lot more going on behind the [scenes](https://rmarkdown.rstudio.com/lesson-2.html), but you shouldn't need to worry about it. 

Now that everything is setup, we can create our first R Markdown document by opening up R Studio, selecting `FILE -> NEW FILE -> Rmarkdown`. A dialog box will appear asking for some basic input parameters for your R markdown document. Add your title and select PDF as your default output format (you can always change these later if you want). A new file should appear that's already populated with some basic script illustrating the key components of an R markdown document. 

### Understanding rmarkdown

Your first reaction when you opened your newly created R markdown document is probably that it doesn't look anything at all like something you'd show your prof. You're right, what we're seeing is the plain text code which needs to be compiled (called *knit* in R Studio) to create the final document. When we create a R markdown document like this in R Studio a bunch of example code is already written. We can compile this document (see below) to see what it looks like, but let's break down the primary components. At the top of the document you might see something that looks like this:

```{r, eval = FALSE}
---
title: "Temporal Analysis of Foot Impacts While Birling Down the White Water"
author: "Jean Guy Rubberboots"
date: "24/06/2021"
output: pdf_document
---
```

This section is known as the *preamble* and it's where you specify most of the document parameters. In the example we can see that the document title is ["Temporal Analysis of Foot Impacts While Birling Down the White Water"](https://www.youtube.com/watch?v=upsZZ2s3xv8), it's written by Jean Guy Rubberboots, on the 24th of June, and the default output is a PDF document. You can modify the preamble to suit your needs. For example, if you wanted to change the title you would write `title: "Your Title Here"` in the preamble. Note that none of this is `R` code, rather it's `YAML`, the syntax for the document's metadata. Apart from what's shown you shouldn't need to worry about this much, just remember that indentation in YAML [matters](https://bookdown.org/yihui/rmarkdown/pdf-document.html). 

Reading further down the default R markdown code, we can see different pre-generated blocks of text. Most of this is just examples of simple formatting and can be deleted when you're ready to add your own content. In R markdown most of what we write will be interpreted as body text (i.e. stuff that you want folks to read) in the knitted document. **To actually run R code** as part of your document, see below.

### Running code in rmarkdown

There are two ways to write `R` code in markdown:

- **Setup a code chunk**. Code chunks start with three back-ticks like this: ` ```{r}`, where `r` indicates you're using the R language You end a code chunk using three more backticks like this ` ``` `.

  - You can add formatting options inside the curly braces. For example, ` ```{r, fig.height = 2}` sets figure height to 2 inches. The following code tells markdown you're running code written in `R`, that when you compile your document this code chunk should be evaluated, and that the resulting figure should have the caption "Some Caption". 

```markdown
`r '```{r, eval = FALSE, fig.cap = "Some caption"}

# some code to generate a plot worth captioning. 

'```
```

See the *R Markdown Formatting* section below for more details. 
  
- **Inline code expression**, which starts with  `` `r ``  and ends with `` ` `` in the body text on the same line.

  - Earlier we calculated `x <- 2 + 2`, we can use inline expressions to recall that value. Writing the following in markdown:
    
```markdown
`r 'We found that x is `r x` 
```
will produce the following in the compiled document: 

We found that x is `r x`


A screenshot of how this document, the one you're reading, appeared in R Studio is shown in the image below.   
  
Individual code chunks can be run using the *Run current chunk* button (See figure 2). This is a great way to tinker with your code before you compile your document. See Chapter 5.1.3 for instructions on compiling.

The second option is to compile your entire document using the *Knit document* button, shown in the figure below. See [Compiling your report] for more details. 

**Note: all the code chunks in a single markdown document work together like a normal R script.** That is if we assign a value to a variable in the first chunk, we can call this variable in the second chunk; the same applies for libraries. **Also note that every time you compile a markdown document, it's done in a "fresh" R session.** If you're calling a variable that exist in your working environment, but isn't explicitly created in the markdown document you'll get an error.   

  
![How this document, the one you're reading, appeared in RStudio; to see the final results scroll up to the line plot at the start of this chapter. Note the "knit" and "run current chunk" buttons. ](images/exampleRMarkdown.PNG)

### Compiling your report

To create a PDF ready to hand in we'll need to compile, or knit, our entire markdown document as mentioned above. To knit (or compile) our R markdown script, simply click the  *knit* button in R Studio (yellow box, Figure 2). You can specify what output you would like and R Studio will (hopefully) compile the script. Knitting will sequentially run all of your code chunks, generate all the text, knit the two together and output a PDF. This can take some time, depending on how much code there is to run, so it's best to save this until you're finished preparing the document. 


You'll most likely be exporting your rmarkdown documents as PDFs, but the beauty of rmarkdown is it doesn't stop there. Your rmarkdown documents can be knitted as a HTML document, a book, or even an HTML book like the one you're reading now!. You can also make slideshow presentations and yes, if need be, export as a word document that you can open in *Microsoft Word*.

Here are some links to help you in exporting your document to common formats:

  - [`pdf_document`](https://bookdown.org/yihui/rmarkdown/pdf-document.html) creates a PDF document via Latex; probably your best default option. 
  - [`word_document`](https://bookdown.org/yihui/rmarkdown/word-document.html) creates a Word document. Note that the formatting options are pretty basic, so while evereything will be where you want it to be, you'll need to pretty it up in Word to comply with your instructors specifications. 
  - [`tufte_handout`](https://bookdown.org/yihui/rmarkdown/tufte-handouts.html) for a PDF handout in the style of Edward Tufte. Check it out. 
  - [`ioslides_presentation`](https://bookdown.org/yihui/rmarkdown/ioslides-presentation.html), [`revealjs::revealjs_presentation`](https://bookdown.org/yihui/rmarkdown/ioslides-presentation.html), and [`powerpoint_presentation`](https://bookdown.org/yihui/rmarkdown/powerpoint-presentation.html) are all options to create sldieshow presentations. I personally use `revealjs` for my own work. It has the steepest learning curve of the bunch, but once setup, you can make incredibly slick slides with ease. 
    - Note: like `word_document`, `powerpoint_presentation`'s outputs are stylistically simple. You'll definitly need to pretty them up manually in Powerpoint.

## So now what do I do with R Markdown? 

You do science and you write it down! 

In all seriousness though, this document was only meant to introduce you to R markdown, and to make the case that you should use it for your coursework. A couple of the most useful elements are talked about below, and there is a wealth of helpful resources for formatting your documents. Just remember to keep it simple, there's no need to reinvent the wheel. The default R markdown outputs are plenty fine with us.

### R Markdown resources and further reading

There's a plethora of helpful online resources to help hone your R markdown skills. We'll list a couple below (the titles are links to the corresponding document): 

- [Chapter 2](https://bookdown.org/yihui/rmarkdown/basics.html) of the *[R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/)* by Xie, Allair & Grolemund (2020). This is the simplest, most comprehensive, guide to learning R markdown and it's available freely online. 
- *[The R markdown cheat sheet](https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf)*, a great resource with the most common R markdown operations; keep on hand for quick referencing. 
- *[Bookdown: Authoring Books and Technical Documents with R Markdown](https://bookdown.org/yihui/bookdown/)* (2020) by Yihui Xie. Explains the `bookdown` package which greatly expands the capabilities of R markdown. For example, the table of contents of this document is created with `bookdown`. 

## Summary

In this chapter we've covered:

  - Why you should be using R Markdown instead of Microsoft Word to write your lab reports from now on
  - How to create and compile R Markdown files
  - Running code within R Markdown

Below we've provided a summary of some basic formatting options for those who want them, but if you're not interested right now, then feel free to skip to Chapter 6 for a quick exercise that should help solidify all the concepts covered in Section 1.


## R Markdown formatting (Optional)

Your R code is run in chunks and the results will be embedded in the final output file. To each chunk you can specify options that'll effect how you're code chunk is run and displayed in the final output document. You include options in the chunk delimiters ` ```{r}` and ` ``` `. 

The most common and useful chunk options are shown below. Note that they all have a default value. For example, `eval` tells R markdown whether the code within the block should be run. It's default option is  `TRUE`, so by default any code in a chunk will be run when you knit your document. If you don't want that code to be run, but still displayed, you would set `eval = FALSE`. Another example would be setting `echo = FALSE` which allows the code to run, but the code *won't* be displayed on the output document (the outputs will still be displayed though); useful for creating clean documents with plots only (i.e. lab reports...). 


option | default | effect
-------|---------|--------
eval | TRUE | whether to evaluate the code and include the results
echo | TRUE | whether to display the code along with its results
warning | TRUE | whether to display warnings
error | FALSE | whether to display errors 
message | TRUE | whether to display messages
tidy | FALSE | whether to reformat code in a tidy way when displaying it
fig.width | 7 | width in inches for plots created in chunk
fig.height | 7 | height in inches for plots created in chunk 
fig.cap | NA | include figure caption, must be in quotation makrs ("")


### Inserting images

Images not produced by R code can easily be inserted into your document. The markdown code isn't R code, so between paragraphs of bodytext insert the following code. Note that compiling to PDF, the LaTeX call will place your image in the "optimal" location, so you might find your image isn't exactly where you though it would be. A quick google search can help you out if this is problem. 

```markdown
![Caption for the picture.](path/to/image.png){width=50%, height=50%}
```

Note that in the above the use of image atributes, the `{width=50%, height=50%}` at the end. This is how you'll adjust the size of your image. Other dimensions you can use include `px, cm, mm, in, inch`, and `%`. 

### Generating Tables

There's multiple methods to create tables in R markdown. Assuming you want to display results calculated through R code, you can use the `kable()` function. Please consult [Chapter 10](https://bookdown.org/yihui/rmarkdown-cookbook/kable.html) of the *R Markdown Cookbook* for additional support. 

Alternatively, if you want to create simple tables manually use the following code in the main body, outside of an `R` code chunk. You can increase the number of rows/columns and the location of the horizontal lines. To generate more complex tables, see the `kable()` function and the `kableExtra` package. 

```markdown
Header 1 | Header 2| Header 3
---------|---------|---------|
Row 1    | Data    | Some other Data
Row 2    | Data    | Some other Data
---------|---------|---------|
```
Header 1 | Header 2| Header 3
---------|---------|---------|
Row 1    | Data    | Some other Data
Row 2    | Data    | Some other Data

### Spellcheck in R Markdown 

While writing an R markdown document in R studio, go to the `Edit` tab at the top of the window and select `Check Spelling`. You can also use the `F7` key as a shortcut. The spell checker will literally go through every word it thinks you've misspelled in your document. You can add words to it so your spell checker's utility grows as you use it. **Note** that the spell check with also check your R code; be wary of changing words in your code chunks because you may get an error down the line. 

### R markdown syntax

Unlike *Microsoft Word*, RMarkdown utilizes a specific syntax for text formatting. Once you get used to it, it makes typing documents much easier than *Words* approach. The table below is how some of the most common text formatting is typed in your Rmarkdown document (syntax & example column) and how it'll appear in the final output. 

| Text formatting |       syntax |                 Example |        Example output |
|-----------------|-------------:|------------------------:|----------------------:|
| italics         |     \*text\* |     this is \*italics\* |     this is *italics* |
| bold            | \*\*text\*\* |    this is \*\*bold\*\* |      this is **bold** |
| subscript       |     \~text\~ |   this is \~subscript\~ |   this is ~subscript~ |
| superscript     |     \^text\^ | this is \^superscript\^ | this is ^superscript^ |
| monospace       |     \`text\` |  this is \`monospaced\` |   this is `monospace` |

For a collection of other RMarkdown syntax, please see the useful (and brief) list compiled online [here](https://rmarkdown.rstudio.com/authoring_basics.html). This includes ordered and unordered lists, headers, code blocks, hyperlinks, and figure captions. 

  

### RStudio tips and tricks

To further the usefulness of rmarkdown, the latest release of RStudio has a *Visual R Markdown* editor which introduces many useful features for authoring documents in rmarkdown. Some of the most pertinent are: 

  - [Visual editor](https://rstudio.github.io/visual-markdown-editing/) so you can see how your document looks (top left of script pane)
  - Combining Zotero and RStudio for easy citatiosn of your document (read more [here](https://rstudio.github.io/visual-markdown-editing/citations.html)
  - Spell check either via `F7` or `Edit -> Check Spelling`
  
